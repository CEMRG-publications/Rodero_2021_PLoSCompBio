#!/bin/bash

#SBATCH -p compute
#SBATCH -J 21HC_biv_wk3
#SBATCH -t 0-24:00:00
#SBATCH --nodes=2
#SBATCH --ntasks-per-node=64
#SBATCH --mail-user=cristobal.rodero_gomez@kcl.ac.uk
#SBATCH --mail-type=ALL

NPROC=128
source ${HOME}/.bashrc
export OMP_NUM_THREADS=1

solver_folder="/scratch/crg17/solver_files/resources"
meshes_folder="/scratch/crg17/meshes"
case_num=21HC_biv
alpha_method=0
JOBNAME=21HC_biv_wk3
################################################################################
# Execute simulation

mpiexec -np $NPROC $CARPENTRYDIR/carp.pt \
  +F $solver_folder/options/pt_ell_amg_large \
  +F $solver_folder/options/pt_para_amg_large \
  +F $solver_folder/options/pt_mech_amg_large \
  -ellip_use_pt 1 \
  -parab_use_pt 1 \
  -purk_use_pt 0 \
  -mech_use_pt 1 \
  -ellip_options_file $solver_folder/options/pt_ell_amg_large \
  -parab_options_file $solver_folder/options/pt_para_amg_large \
  -purk_options_file $solver_folder/petsc_options/mumps_opts_nonsymmetric \
  -mechanics_options_file $solver_folder/options/pt_mech_amg_large \
  -vectorized_fe 0 \
  -mech_finite_element 0 \
  -simID $JOBNAME \
  -meshname $meshes_folder/$case_num/heart_case$case_num"_800um" \
  -timedt 1.0 \
  -mechDT 1.0 \
  -spacedt 1 \
  -chkpt_intv 100 \
  -tend 800.0 \
  -loadStepping 50.0 \
  -num_mechanic_nbc 3 \
  -mechanic_nbc[0].name LV_endo \
  -mechanic_nbc[0].surf_file $meshes_folder/$case_num/LV_endo \
  -mechanic_nbc[0].pressure 1.6 \
  -mechanic_nbc[1].name RV_endo \
  -mechanic_nbc[1].surf_file $meshes_folder/$case_num/RV_endo \
  -mechanic_nbc[1].pressure 0.8 \
  -mechanic_nbc[2].name Pericardium \
  -mechanic_nbc[2].surf_file $meshes_folder/$case_num/epicardium_ventricles \
  -mechanic_nbc[2].spring_idx 0 \
  -mechanic_nbc[2].nspring_idx 0 \
  -mechanic_nbc[2].nspring_config 1 \
  -num_mechanic_bs 1 \
  -mechanic_bs[0].edidx 0 \
  -mechanic_bs[0].value 0.001 \
  -num_mechanic_ed 1 \
  -mechanic_ed[0].ncomp 1 \
  -mechanic_ed[0].file $meshes_folder/$case_num/PM_$case_num \
  -numSurfVols 2 \
  -surfVols[0].name LV_endo \
  -surfVols[0].surf_file $meshes_folder/$case_num/LV_endo \
  -surfVols[0].grid 8 \
  -surfVols[1].name RV_endo \
  -surfVols[1].surf_file $meshes_folder/$case_num/RV_endo \
  -surfVols[1].grid 8 \
  -num_cavities 2 \
  -cavities[0].cav_type 0 \
  -cavities[0].cavP 0 \
  -cavities[0].tube 2 \
  -cavities[0].cavVol 0 \
  -cavities[0].p0_cav 12.0 \
  -cavities[0].p0_in 12.0 \
  -cavities[0].p0_out 77.0 \
  -cavities[0].valve 0 \
  -cavities[0].state -1 \
  -cavities[1].cav_type 1 \
  -cavities[1].cavP 1 \
  -cavities[1].tube 2 \
  -cavities[1].cavVol 1 \
  -cavities[1].p0_cav 6.0 \
  -cavities[1].p0_in 6.0 \
  -cavities[1].p0_out 17.4 \
  -cavities[1].valve 0 \
  -cavities[1].state -1 \
  -num_mregions 2 \
  -mregion[0].name "Ventricles" \
  -mregion[0].num_IDs 4 \
  -mregion[0].ID[0] 1 \
  -mregion[0].ID[1] 2 \
  -mregion[0].ID[2] 25 \
  -mregion[0].ID[3] 26 \
  -mregion[0].params "kappa=1000,b_f=8.0,b_fs=4.0,b_t=3.0,a=1.7" \
  -mregion[0].type 9 \
  -mregion[1].name "Valve planes" \
  -mregion[1].num_IDs 4 \
  -mregion[1].ID[0] 7 \
  -mregion[1].ID[1] 8 \
  -mregion[1].ID[2] 9 \
  -mregion[1].ID[3] 10 \
  -mregion[1].params "kappa=1000,c=1000.0" \
  -mregion[1].type 2 \
  -CV_coupling 0 \
  -CV_FE_coupling 1 \
  -CVS_mode 0 \
  -lv_wk3.name Aorta \
  -lv_wk3.R1 0.03 \
  -lv_wk3.R2 0.63 \
  -lv_wk3.C 5.16 \
  -mitral_valve.Rfwd 0.05 \
  -mitral_valve.Rbwd 1000.0 \
  -aortic_valve.Rfwd 0.0 \
  -rv_wk3.name PA \
  -rv_wk3.R1 0.015 \
  -rv_wk3.R2 0.1008 \
  -rv_wk3.C 21.156 \
  -tricuspid_valve.Rfwd 0.05 \
  -tricuspid_valve.Rbwd 1000.0 \
  -pulmonic_valve.Rfwd 0.0 \
  -mech_vol_split_aniso 1 \
  -volumeTracking 1 \
  -numElemVols 1 \
  -elemVols[0].name tissue \
  -elemVols[0].grid 8 \
  -pstrat 1 \
  -pstrat_i 1 \
  -krylov_tol_mech 1e-10 \
  -krylov_norm_mech 0 \
  -krylov_maxit_mech 5000 \
  -newton_atol_mech 1e-06 \
  -newton_tol_mech 1e-06 \
  -newton_adaptive_tol_mech 2 \
  -newton_tol_cvsys 1e-03 \
  -newton_line_search 0 \
  -newton_maxit_mech 20 \
  -num_stim 1 \
  -stimulus[0].stimtype 8 \
  -stimulus[0].data_file $meshes_folder/$case_num/$case_num"_vm_act_seq.dat" \
  -diffusionOn 0 \
  -num_imp_regions 2 \
  -imp_region[0].name ventricles \
  -imp_region[0].im TT2 \
  -imp_region[0].num_IDs 4 \
  -imp_region[0].ID[0] 1 \
  -imp_region[0].ID[1] 2 \
  -imp_region[0].ID[2] 25 \
  -imp_region[0].ID[3] 26 \
  -imp_region[1].name others \
  -imp_region[1].im PASSIVE \
  -imp_region[1].num_IDs 4 \
  -imp_region[1].ID[0] 7 \
  -imp_region[1].ID[1] 8 \
  -imp_region[1].ID[2] 9 \
  -imp_region[1].ID[3] 10 \
  -imp_region[0].plugins TanhStress \
  -imp_region[0].plug_param "t_emd=20,Tpeak=120.0,tau_c0=50.0,tau_r=50.0,t_dur=550.0,lambda_0=0.7,ld=6.0,ld_up=500.0,ldOn=0,VmThresh=-60.0" \
  -gridout_i 0 \
  -mech_output 1 \
  -strain_value 0 \
  -stress_value 0 \
  -mech_activate_inertia $alpha_method \
  -mass_lumping 1 \
  -mech_rho_inf 0.0 \
  -mech_stiffness_damping 0.1 \
  -mech_mass_damping 0.1 \